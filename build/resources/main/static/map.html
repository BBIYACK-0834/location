<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìë™ ìœ„ì¹˜ ì¥ì†Œ ë“±ë¡</title>

  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Malgun Gothic', sans-serif; }
    
    #map { width: 100%; height: 100vh; }

    /* ë©”ì¸ ì¥ì†Œ ë“±ë¡ ë²„íŠ¼ */
    #registerBtn {
      position: absolute; top: 20px; left: 20px;
      padding: 12px 20px; background-color: #4CAF50;
      color: white; border: none; border-radius: 8px;
      cursor: pointer; z-index: 2; font-weight: bold; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 16px;
    }

    /* ë“±ë¡ í¼ (ëª¨ë‹¬) */
    #placeForm {
      display: none; position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: white; padding: 25px;
      border-radius: 15px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
      z-index: 100; width: 320px; max-height: 90vh; overflow-y: auto;
    }

    h3 { margin-top: 0; text-align: center; margin-bottom: 20px; color: #333; }

    /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-top: 12px; margin-bottom: 4px; }
    
    input[type="text"], textarea, input[type="file"] {
      width: 100%; padding: 10px; box-sizing: border-box;
      border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
      background-color: #fff;
    }
    
    input[type="text"]:focus, textarea:focus { border-color: #4CAF50; outline: none; }
    textarea { resize: vertical; }

    /* ì½ê¸° ì „ìš© í•„ë“œ (ì¢Œí‘œ) - ë¡œë”© ì¤‘ì¼ ë•Œ ìƒ‰ìƒ ë³€ê²½ */
    input[readonly] { background-color: #f9f9f9; color: #555; cursor: default; }

    /* í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ */
    .btn-group { margin-top: 25px; display: flex; gap: 10px; }
    .btn-group button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 15px; }
    .btn-save { background-color: #4CAF50; }
    .btn-close { background-color: #888; }

    /* í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ */
    .cluster-marker {
      position: relative; background: white; border-radius: 50%;
      width: 60px; height: 60px; overflow: hidden;
      border: 3px solid #4CAF50; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
    }
    .cluster-marker img { width: 100%; height: 100%; object-fit: cover; }
    .cluster-count {
      position: absolute; bottom: 0; right: 0; background-color: red; color: white;
      width: 24px; height: 24px; font-size: 12px; font-weight: bold;
      border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2;
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b00e9c16d27cc5857e6ce25b69f784aa"></script>
</head>
<body>

<div id="map"></div>

<button id="registerBtn" onclick="openFormAndGetGPS()">ğŸ“ ì¥ì†Œ ë“±ë¡</button>

<div id="placeForm">
  <h3>ì¥ì†Œ ë“±ë¡</h3>
  
  <p style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">
    í˜„ì¬ ìœ„ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
  </p>

  <div style="display:flex; gap:10px;">
    <div style="flex:1;">
      <label>ìœ„ë„</label>
      <input type="text" id="placeLat" readonly placeholder="ìœ„ì¹˜ í™•ì¸ ì¤‘...">
    </div>
    <div style="flex:1;">
      <label>ê²½ë„</label>
      <input type="text" id="placeLng" readonly placeholder="ìœ„ì¹˜ í™•ì¸ ì¤‘...">
    </div>
  </div>

  <label>ì¥ì†Œ ì´ë¦„</label>
  <input type="text" id="placeName" placeholder="ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">

  <label>ì„¤ëª…</label>
  <textarea id="placeDesc" rows="3" placeholder="ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…"></textarea>

  <label>ì¹´í…Œê³ ë¦¬</label>
  <input type="text" id="placeCategory" placeholder="ì˜ˆ: ë§›ì§‘, ì‚°ì±…ë¡œ">

  <label>ì´ë¯¸ì§€</label>
  <input type="file" id="placeImage" accept="image/*">

  <div class="btn-group">
    <button class="btn-save" onclick="registerPlace()">ì €ì¥</button>
    <button class="btn-close" onclick="closeForm()">ì·¨ì†Œ</button>
  </div>
</div>

<script>
// ----------------------------------------------------
// 1. ì§€ë„ ì´ˆê¸°í™”
// ----------------------------------------------------
const mapContainer = document.getElementById('map');
const mapOption = {
    center: new kakao.maps.LatLng(37.566826, 126.9786567),
    level: 5 
};

const map = new kakao.maps.Map(mapContainer, mapOption);

let clusterPositions = []; 
let clusterOverlays = [];  
let imageIntervals = [];   

// ----------------------------------------------------
// 2. í¼ ì—´ê¸° + GPS ìë™ ì‹¤í–‰ (í•µì‹¬ ë¡œì§)
// ----------------------------------------------------
function openFormAndGetGPS() {
    // 1. í¼ ì—´ê¸°
    document.getElementById('placeForm').style.display = 'block';
    
    // 2. ê¸°ì¡´ ê°’ ì´ˆê¸°í™” (ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ)
    document.getElementById('placeName').value = '';
    document.getElementById('placeDesc').value = '';
    document.getElementById('placeCategory').value = '';
    document.getElementById('placeImage').value = '';
    
    document.getElementById('placeLat').value = "ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...";
    document.getElementById('placeLng').value = "ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...";

    // 3. GPS ê°€ì ¸ì˜¤ê¸° ì‹œì‘
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // ê°’ ì±„ìš°ê¸°
                document.getElementById('placeLat').value = lat;
                document.getElementById('placeLng').value = lng;

                // ì§€ë„ë¥¼ í˜„ì¬ ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
                const locPosition = new kakao.maps.LatLng(lat, lng);
                map.panTo(locPosition);
            },
            (err) => {
                console.error(err);
                alert("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                document.getElementById('placeLat').value = "ì‹¤íŒ¨";
                document.getElementById('placeLng').value = "ì‹¤íŒ¨";
            },
            {
                enableHighAccuracy: true, // ì •í™•ë„ ë†’ì„
                timeout: 5000,            // 5ì´ˆ ì•ˆì— ëª» ì°¾ìœ¼ë©´ ì—ëŸ¬
                maximumAge: 0
            }
        );
    } else {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

function closeForm() {
    document.getElementById('placeForm').style.display = 'none';
}


// ----------------------------------------------------
// 3. í´ëŸ¬ìŠ¤í„°ë§ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
// ----------------------------------------------------
function averagePosition(positions) {
  let lat = 0, lng = 0;
  positions.forEach(p => { lat += p.getLat(); lng += p.getLng(); });
  return new kakao.maps.LatLng(lat / positions.length, lng / positions.length);
}

function getPixelDistance(map, latlng1, latlng2) {
  const proj = map.getProjection();
  const p1 = proj.pointFromCoords(latlng1);
  const p2 = proj.pointFromCoords(latlng2);
  const dx = p1.x - p2.x;
  const dy = p1.y - p2.y;
  return Math.sqrt(dx * dx + dy * dy);
}

function groupClustersByDistance(points) {
  const groups = [];
  const visited = new Set();
  const THRESHOLD = 80; 

  for (let i = 0; i < points.length; i++) {
    if (visited.has(i)) continue;
    const group = [points[i]];
    visited.add(i);

    for (let j = i + 1; j < points.length; j++) {
      if (visited.has(j)) continue;
      const d = getPixelDistance(map, points[i].position, points[j].position);
      if (d < THRESHOLD) {
        group.push(points[j]);
        visited.add(j);
      }
    }
    groups.push(group);
  }
  return groups;
}

function renderClusters() {
  clusterOverlays.forEach(o => o.setMap(null));
  clusterOverlays = [];
  imageIntervals.forEach(i => clearInterval(i));
  imageIntervals = [];

  let groups;
  if (map.getLevel() > 7) {
    groups = groupClustersByDistance(clusterPositions);
  } else {
    groups = clusterPositions.map(c => [c]);
  }

  groups.forEach(group => {
    const pos = averagePosition(group.map(g => g.position));
    const content = document.createElement('div');
    content.className = 'cluster-marker';

    const img = document.createElement('img');
    img.src = group[0].imageSrc || "https://via.placeholder.com/100"; 
    content.appendChild(img);

    if (group.length > 1) {
      const count = document.createElement('div');
      count.className = 'cluster-count';
      count.textContent = group.length;
      content.appendChild(count);
    }

    let currentIndex = 0;
    if (group.length > 1) {
      const interval = setInterval(() => {
        currentIndex = (currentIndex + 1) % group.length; 
        img.src = group[currentIndex].imageSrc;           
      }, 1500); 
      imageIntervals.push(interval);
    }

    const overlay = new kakao.maps.CustomOverlay({
      position: pos,
      content: content,
      yAnchor: 1
    });

    overlay.setMap(map);
    clusterOverlays.push(overlay);

    content.addEventListener('click', () => {
      const selectedPlace = group[currentIndex]; 
      onClusterClick(selectedPlace);
    });
  });
}

function onClusterClick(place) {
  const newWindow = window.open("", "_blank", "width=400,height=500");
  const displayImg = place.imageSrc ? place.imageSrc : "https://via.placeholder.com/150";

  newWindow.document.write(`
    <html>
    <head>
      <title>ì¥ì†Œ ìƒì„¸</title>
      <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; }
        h2 { margin-bottom: 5px; color: #333; }
        .cate { color: #888; font-size: 14px; margin-bottom: 20px; display: inline-block; background: #eee; padding: 4px 8px; border-radius: 4px; }
        .desc { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 8px; line-height: 1.6; }
        p { color: #aaa; font-size: 12px; margin-top: 10px; }
        button { margin-top: 20px; padding: 10px 20px; cursor: pointer; }
      </style>
    </head>
    <body>
      <img src="${displayImg}" />
      <h2>${place.name || 'ì´ë¦„ ì—†ëŠ” ì¥ì†Œ'}</h2>
      <span class="cate">${place.category || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'}</span>
      <div class="desc">${place.desc || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
      <p>ìœ„ë„: ${place.position.getLat()}, ê²½ë„: ${place.position.getLng()}</p>
      <button onclick="window.close()">ë‹«ê¸°</button>
    </body>
    </html>
  `);
}


// ----------------------------------------------------
// 4. ì„œë²„ ë“±ë¡
// ----------------------------------------------------
function registerPlace() {
  const name = document.getElementById('placeName').value;
  const desc = document.getElementById('placeDesc').value;
  const category = document.getElementById('placeCategory').value;
  const lat = document.getElementById('placeLat').value;
  const lng = document.getElementById('placeLng').value;
  const file = document.getElementById('placeImage').files[0];

  if (lat === "ìœ„ì¹˜ ì°¾ëŠ” ì¤‘..." || lat === "ì‹¤íŒ¨") {
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (!name || !desc) {
    alert("ì¥ì†Œ ì´ë¦„ê³¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const formData = new FormData();
  formData.append("placename", name);
  formData.append("placeExp", desc);
  formData.append("category", category);
  formData.append("latitude", lat);
  formData.append("longitude", lng);
  if (file) formData.append("uploadFile", file);

  fetch("https://glorious-broccoli-599jx6g57jxh4rwx-8080.app.github.dev/place/add", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    // ì„±ê³µ ì‹œ ì²˜ë¦¬
    if (true) { 
      alert("ì¥ì†Œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      closeForm();

      clusterPositions.push({
        position: new kakao.maps.LatLng(Number(lat), Number(lng)),
        imageSrc: file ? URL.createObjectURL(file) : "https://via.placeholder.com/100",
        name: name,         
        desc: desc,        
        category: category, 
        count: 1
      });

      renderClusters(); 
      map.panTo(new kakao.maps.LatLng(Number(lat), Number(lng)));
    }
  })
  .catch(err => {
    console.error(err);
    alert("ì˜¤ë¥˜ ë°œìƒ (ì½˜ì†” í™•ì¸)");
  });
}

kakao.maps.event.addListener(map, 'zoom_changed', renderClusters);
kakao.maps.event.addListener(map, 'dragend', renderClusters);

</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>줌 레벨에 따라 클러스터 합치기 (축소하면 합침)</title>
  <style>
    #map {
      width: 100%;
      height: 600px;
    }
    .cluster-marker {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .cluster-marker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      user-select: none;
    }
    .cluster-count {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 2px 5px;
      border-radius: 12px;
      user-select: none;
    }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b00e9c16d27cc5857e6ce25b69f784aa"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const baseLat = 37.5665;
    const baseLng = 126.9780;
    const clusterCount = 20;
    const imageSrc = '/mnt/data/5de73308-2d3a-4716-8fac-b82f4db5d259.png'; // 업로드 이미지 경로

    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(baseLat, baseLng),
      level: 8
    });

    // 클러스터 위치와 개수 배열 생성
    const clusterPositions = [];
    for(let i=0; i<2; i++) {
      const latOffset = (Math.random() - 0.5) * 0.1;
      const lngOffset = (Math.random() - 0.5) * 0.1;
      clusterPositions.push({
        position: new kakao.maps.LatLng(baseLat + latOffset, baseLng + lngOffset),
        count: Math.floor(Math.random() * 100) + 1
      });
    }

    let clusterOverlays = [];

    // 위치 평균 계산 함수
    function averagePosition(positions) {
      let latSum = 0, lngSum = 0;
      positions.forEach(p => {
        latSum += p.getLat();
        lngSum += p.getLng();
      });
      return new kakao.maps.LatLng(latSum / positions.length, lngSum / positions.length);
    }

    // 줌 레벨에 따라 클러스터 묶기 (level 9 이상 확대: 개별, 그 이하면 2개씩 묶음)
    function getClustersForLevel(level) {
      if(level <= 9) {
        return clusterPositions.map(c => [c]);
      } else {
        const clusters = [];
        for(let i=0; i<clusterPositions.length; i += 2) {
          clusters.push(clusterPositions.slice(i, i+2));
        }
        return clusters;
      }
    }

    // 클러스터 렌더링 함수
    function renderClusters() {
      const level = map.getLevel();

      // 기존 오버레이 모두 제거
      clusterOverlays.forEach(o => o.setMap(null));
      clusterOverlays = [];

      const clusters = getClustersForLevel(level);

      clusters.forEach(group => {
        const positions = group.map(c => c.position);
        const clusterCount = group.reduce((sum, c) => sum + c.count, 0);
        const clusterPos = averagePosition(positions);

        const content = document.createElement('div');
        content.className = 'cluster-marker';

        const img = document.createElement('img');
        img.src = imageSrc;
        content.appendChild(img);

        const countDiv = document.createElement('div');
        countDiv.className = 'cluster-count';
        countDiv.textContent = clusterCount;
        content.appendChild(countDiv);

        const overlay = new kakao.maps.CustomOverlay({
          position: clusterPos,
          content: content,
          yAnchor: 1
        });
        overlay.setMap(map);
        clusterOverlays.push(overlay);
      });
    }

    // 초기 렌더링
    renderClusters();

    // 줌 변경 및 드래그 종료 시 다시 렌더링
    kakao.maps.event.addListener(map, 'zoom_changed', renderClusters);
    kakao.maps.event.addListener(map, 'dragend', renderClusters);
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>모바일 최적화 클러스터 지도</title>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
    #map { width: 100%; height: 100vh; }

    #registerBtn {
      position: absolute; top: 20px; left: 20px;
      padding: 10px 20px; background-color: #4CAF50;
      color: white; border: none; border-radius: 5px;
      cursor: pointer; z-index: 2;
    }

    #placeForm {
      display: none; position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: white; padding: 20px;
      border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      z-index: 10; width: 300px;
    }

    #placeForm input, #placeForm textarea {
      width: 100%; margin-bottom: 10px; padding: 8px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 4px;
    }

    #placeForm button {
      background-color: #4CAF50; color: white;
      padding: 10px 20px; border: none; border-radius: 5px;
      cursor: pointer;
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b00e9c16d27cc5857e6ce25b69f784aa"></script>
</head>
<body>

<div id="map"></div>

<button id="registerBtn">장소 등록</button>

<div id="placeForm">
  <h3>장소 등록</h3>
  <label>장소 이름</label>
  <input type="text" id="placeName" required>
  <label>장소 설명</label>
  <textarea id="placeDesc" rows="4" required></textarea>
  <label>카테고리</label>
  <input type="text" id="placeCategory" required>
  <label>이미지 업로드</label>
  <input type="file" id="placeImage" accept="image/*">
  <label>위도</label>
  <input type="text" id="placeLat" readonly>
  <label>경도</label>
  <input type="text" id="placeLng" readonly>
  <button onclick="registerPlace()">등록</button>
</div>

<script>
const map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5665, 126.9780),
  level: 8
});

const clusterPositions = [];  // 클러스터 데이터
let clusterOverlays = [];

// 클러스터 평균 위치 계산
function averagePosition(positions) {
  let latSum = 0, lngSum = 0;
  positions.forEach(p => { latSum += p.getLat(); lngSum += p.getLng(); });
  return new kakao.maps.LatLng(latSum / positions.length, lngSum / positions.length);
}

// 클러스터 렌더링
function renderClusters() {
  clusterOverlays.forEach(o => o.setMap(null));
  clusterOverlays = [];

  const clusters = clusterPositions.map(c => [c]); // 간단하게 1:1로 처리

  clusters.forEach(group => {
    const clusterPos = averagePosition(group.map(c => c.position));
    const content = document.createElement('div');
    content.className = 'cluster-marker';

    const img = document.createElement('img');
    img.src = group[0].imageSrc;
    content.appendChild(img);

    const countDiv = document.createElement('div');
    countDiv.className = 'cluster-count';
    countDiv.textContent = group.length;
    content.appendChild(countDiv);

    const overlay = new kakao.maps.CustomOverlay({
      position: clusterPos,
      content: content,
      yAnchor: 1
    });
    overlay.setMap(map);
    clusterOverlays.push(overlay);

    // 클러스터 클릭 → 서버에서 장소 리스트 가져오기
    content.addEventListener('click', () => onClusterClick(clusterPos));
  });
}

// 지도 클릭 → 위도/경도 입력
kakao.maps.event.addListener(map, 'click', e => {
  const latlng = e.latLng;
  document.getElementById("placeLat").value = latlng.getLat();
  document.getElementById("placeLng").value = latlng.getLng();
});

// 장소 등록 버튼
document.getElementById('registerBtn').onclick = () => {
  document.getElementById('placeForm').style.display = 'block';
};

// 장소 등록
function registerPlace() {
  const name = document.getElementById("placeName").value;
  const desc = document.getElementById("placeDesc").value;
  const category = document.getElementById("placeCategory").value;
  const lat = document.getElementById("placeLat").value;
  const lng = document.getElementById("placeLng").value;
  const file = document.getElementById("placeImage").files[0];

  if (!name || !desc || !category || !lat || !lng) { alert("모든 필드를 입력해주세요."); return; }

  const formData = new FormData();
  formData.append("placename", name);
  formData.append("placeExp", desc);
  formData.append("category", category);
  formData.append("latitude", lat);
  formData.append("longitude", lng);
  if (file) formData.append("uploadFile", file);

  fetch("https://glorious-broccoli-599jx6g57jxh4rwx-8080.app.github.dev/place/add", {
    method: "POST", body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("장소가 등록되었습니다!");
      document.getElementById("placeForm").style.display = "none";

      clusterPositions.push({
        position: new kakao.maps.LatLng(parseFloat(lat), parseFloat(lng)),
        count: 1,
        imageSrc: file ? URL.createObjectURL(file) : '/default-image.png'
      });
      renderClusters();
    } else {
      alert("등록 실패: " + data.message);
    }
  })
  .catch(err => { console.error(err); alert("서버 오류 발생"); });
}

// 클러스터 클릭 → 새 창으로 정보 표시
function onClusterClick(clusterPos) {
  fetch("https://glorious-broccoli-599jx6g57jxh4rwx-8080.app.github.dev/place/list")
    .then(res => res.json())
    .then(data => {
      // 클러스터 중심과 가까운 장소만 필터링 (0.05 범위)
      const filtered = data.filter(place => {
        const lat = parseFloat(place.latitude);
        const lng = parseFloat(place.longitude);
        return Math.abs(lat - clusterPos.getLat()) < 0.05 &&
               Math.abs(lng - clusterPos.getLng()) < 0.05;
      });

      // 새 창에 표시
      const newWindow = window.open("", "_blank", "width=400,height=600,scrollbars=yes");
      newWindow.document.write("<h2>클러스터 장소 목록</h2>");
      filtered.forEach(place => {
        newWindow.document.write(`
          <div style="margin-bottom:10px;">
            <img src="${place.productImagePath ? '/uploads/' + place.productImagePath : '/default.png'}"
                 width="80" height="80" style="object-fit:cover; margin-right:10px;">
            <strong>${place.placename}</strong><br>
            ${place.category}<br>
            ${place.placeExp}
          </div><hr>
        `);
      });
    })
    .catch(err => console.error(err));
}

// 초기 렌더링
renderClusters();
</script>

</body>
</html>
